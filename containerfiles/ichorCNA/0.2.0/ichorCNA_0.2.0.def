Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.03-py3  # CUDA 12 + PyTorch base (supports Dorado GPU)

%labels
    Description "Oxford Nanopore Dorado GPU container (v0.9.1) with Samtools"
    Version "0.9.1"
    Maintainer "hsandakly"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH=/opt/dorado/bin:/usr/local/bin:$PATH

%post
    set -eux
    echo "=== Installing dependencies ==="
    apt-get update && apt-get install -y --no-install-recommends \
        wget ca-certificates build-essential \
        zlib1g-dev libbz2-dev liblzma-dev libcurl4-openssl-dev libdeflate-dev \
        libncurses5-dev libncursesw5-dev pkg-config \
        && rm -rf /var/lib/apt/lists/*

    echo "=== Building and installing Samtools 1.20 ==="
    cd /tmp
    wget -q https://github.com/samtools/samtools/releases/download/1.20/samtools-1.20.tar.bz2
    tar -xjf samtools-1.20.tar.bz2
    cd samtools-1.20
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    hash -r
    cd /
    rm -rf /tmp/samtools-1.20*

    echo "=== Installing Dorado v0.9.1 ==="
    mkdir -p /opt/dorado
    cd /opt/dorado
    wget -q https://cdn.oxfordnanoportal.com/software/analysis/dorado-0.9.1-linux-x64.tar.gz
    tar -xzf dorado-0.9.1-linux-x64.tar.gz --strip-components=1
    rm dorado-0.9.1-linux-x64.tar.gz
    chmod +x /opt/dorado/bin/dorado

%runscript
    echo "Launching Dorado container..."
    exec "$@"

%test
    echo "Running Dorado + Samtools test..."
    dorado --version
    samtools --version
